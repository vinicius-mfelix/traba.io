name: GitHub Actions Dev Environment - AWS Deploy
on: 
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev
jobs:
  Build-Application:
    runs-on: [debian-runner]
    env:
      JAR_FILE: startupone-0.0.1-SNAPSHOT.jar
      DIST_DIR: /home/admin/projects/dist/back-end/dev
      BACK_END_DIR: /home/admin/projects/source-code/back-end/startupone-backend
      JAR_FILE_DIR: /home/admin/projects/source-code/back-end/startupone-backend/target
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    steps:
      - name: Install Maven Artifact
        working-directory: ${{ env.BACK_END_DIR }}
        run: |
            echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
            echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
            git pull origin dev
            git checkout dev
            echo "ğŸ›  Installing Maven dependency..."
            ./mvnw clean install -DskipTests
      - name: Build Maven Artifact Package
        working-directory: ${{ env.BACK_END_DIR }}
        run: |
            echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
            echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
            git checkout dev
            echo "ğŸ›  Building Maven package..."
            ./mvnw clean package -DskipTests
      - name: Clean Docker Container and Image
        run: |
          echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
          echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
          echo "ğŸ³ Cleaning Docker Files..."
          sudo docker rm startupone-api-dev --force
          sudo docker image rm startupone-api-dev --force
      - name: Build Docker Image
        working-directory: ${{ env.BACK_END_DIR }}
        run: |
          echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
          echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
          echo "ğŸ³ Building Docker Image..."
          sudo docker image build -t startupone-api-dev .
      - name: Deploy Docker Image
        run: |
          echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
          echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
          echo "ğŸ³ Deploying Docker Image..."
          sudo docker run --name startupone-api-dev -e DB_HOST=${{ env.DB_HOST }} -e DB_USERNAME=${{ env.DB_USERNAME }} -e DB_PASSWORD=${{ env.DB_PASSWORD}} -p 4000:4000 -d startupone-api-dev:latest

#       ============ Service Systemctl Runner ============
#       - name: Clean Dist Directory
#         working-directory: ${{ env.DIST_DIR }}
#         run: |
#             echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
#             echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
#             echo "ğŸ§¹ Cleaning Dist Directory..."
#             rm -rf *
#             echo "ğŸ›‘ Stopping current server..."
#       - name: Copy Files to Dist Directory
#         working-directory: ${{ env.JAR_FILE_DIR }}
#         run: |
#             echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
#             echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
#             echo "ğŸ’¾ Copying files to the dist directory..."
#             git checkout dev
#             cp ${{ env.JAR_FILE }} ${{ env.DIST_DIR }}
#       - name: Publish Tomcat Service
#         working-directory: ${{ env.DIST_DIR }}
#         run: |
#             echo "ğŸ¯ DEV ENVIRONMENT RUNNING"
#             echo "ğŸ§­ Running on ${{ runner.os }} - AWS Hosted VM"
#             echo "ğŸ“¬ Publishing Server..."
#             sudo chown admin ${{ env.JAR_FILE }}
#             sudo chmod 500 ${{ env.JAR_FILE }}
#             sudo systemctl start startupone-backend-dev.service
#             sudo systemctl status startupone-backend-dev.service
